---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Order Confirmed | M&M Factory Pizza" description="Your order has been confirmed. Thank you for choosing M&M Factory Pizza!">
  <Header />
  
  <main class="pt-24 pb-16 bg-cream min-h-screen">
    <div class="max-w-2xl mx-auto px-4 py-16 text-center">
      <!-- Success Icon -->
      <div class="w-24 h-24 mx-auto mb-8 bg-olive rounded-full flex items-center justify-center">
        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      
      <h1 class="text-3xl md:text-4xl font-bold text-charcoal mb-4">Order Confirmed!</h1>
      
      <!-- Order Number Display -->
      <div id="order-info" class="bg-olive/10 rounded-xl p-4 mb-6 hidden">
        <p class="text-sm text-gray-600">Your Order Number</p>
        <p id="order-number" class="text-2xl font-bold text-olive"></p>
        <p id="payment-status" class="mt-2 hidden"></p>
      </div>
      
      <p class="text-lg text-gray-600 mb-8">
        Thank you for your order. We've received it and are preparing your delicious food.
      </p>
      
      <!-- Order Details Card -->
      <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8 text-left">
        <h2 class="text-xl font-bold text-charcoal mb-4 text-center">What's Next?</h2>
        
        <div class="space-y-4">
          <div class="flex items-start gap-4">
            <div class="w-8 h-8 bg-royal-blue rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-white text-sm font-bold">1</span>
            </div>
            <div>
              <h3 class="font-semibold text-charcoal">SMS Notification</h3>
              <p class="text-gray-600 text-sm">You'll receive an SMS when your order is ready for pickup.</p>
            </div>
          </div>
          
          <div class="flex items-start gap-4">
            <div class="w-8 h-8 bg-royal-blue rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-white text-sm font-bold">2</span>
            </div>
            <div>
              <h3 class="font-semibold text-charcoal">Come Pick Up</h3>
              <p class="text-gray-600 text-sm">Head to our location at Plaça Major, 3 in Pollença.</p>
            </div>
          </div>
          
          <div class="flex items-start gap-4">
            <div class="w-8 h-8 bg-royal-blue rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-white text-sm font-bold">3</span>
            </div>
            <div>
              <h3 class="font-semibold text-charcoal">Enjoy!</h3>
              <p class="text-gray-600 text-sm">Pick up your order and enjoy your authentic Italian pizza!</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Location Reminder -->
      <div class="bg-olive/10 rounded-xl p-4 mb-8">
        <div class="flex items-center justify-center gap-3">
          <svg class="w-5 h-5 text-olive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span class="text-olive font-medium">Plaça Major, 3, 07460 Pollença</span>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a 
          href="/"
          class="inline-flex items-center justify-center px-6 py-3 bg-royal-blue text-white font-semibold rounded-full hover:bg-royal-blue/90 transition-all"
        >
          Back to Home
        </a>
        <a 
          href="tel:+34871531423"
          class="inline-flex items-center justify-center gap-2 px-6 py-3 border-2 border-charcoal text-charcoal font-semibold rounded-full hover:bg-charcoal hover:text-white transition-all"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
          </svg>
          Call Us
        </a>
      </div>
    </div>
  </main>
  
  <Footer />
</Layout>

<script>
  import { useCartStore } from '../stores/cartStore';
  import { createOrder } from '../lib/supabase';
  
  // Check if coming from Stripe payment
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session_id');
  
  async function handleStripeSuccess() {
    if (sessionId) {
      // Coming from Stripe - create order from stored data
      const pendingOrderNumber = sessionStorage.getItem('pendingOrderNumber');
      const pendingOrderItems = sessionStorage.getItem('pendingOrderItems');
      const pendingOrderData = sessionStorage.getItem('pendingOrderData');
      
      if (pendingOrderNumber && pendingOrderItems && pendingOrderData) {
        const items = JSON.parse(pendingOrderItems);
        const data = JSON.parse(pendingOrderData);
        
        try {
          // Create order in database
          const { error } = await createOrder({
            orderNumber: pendingOrderNumber,
            customerName: data.customerName,
            customerPhone: data.customerPhone,
            customerEmail: data.customerEmail || undefined,
            items: items,
            subtotal: data.subtotal,
            tax: data.tax,
            total: data.total,
            notes: data.notes || undefined,
            paymentStatus: 'paid',
            paymentIntentId: sessionId,
          });
          
          if (!error) {
            // Clear cart
            useCartStore.getState().clearCart();
            
            // Display order number
            displayOrderNumber(pendingOrderNumber, true);
            
            // Send confirmation email if customer provided email
            if (data.customerEmail) {
              try {
                await fetch('/api/send-email', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    type: 'order_placed',
                    customerEmail: data.customerEmail,
                    order: {
                      orderNumber: pendingOrderNumber,
                      customerName: data.customerName,
                      items: items,
                      subtotal: data.subtotal,
                      tax: data.tax,
                      total: data.total,
                      paymentStatus: 'paid',
                    }
                  }),
                });
              } catch (emailError) {
                console.error('Failed to send confirmation email:', emailError);
              }
            }
          }
        } catch (e) {
          console.error('Error creating order:', e);
        }
        
        // Clean up session storage
        sessionStorage.removeItem('pendingOrderNumber');
        sessionStorage.removeItem('pendingOrderItems');
        sessionStorage.removeItem('pendingOrderData');
      }
      
      // Clean URL
      window.history.replaceState({}, '', '/order-confirmation');
    } else {
      // Regular order (pay at pickup)
      const orderNumber = sessionStorage.getItem('lastOrderNumber');
      const paymentMethod = sessionStorage.getItem('lastPaymentMethod');
      if (orderNumber) {
        displayOrderNumber(orderNumber, paymentMethod !== 'pickup');
        sessionStorage.removeItem('lastOrderNumber');
        sessionStorage.removeItem('lastOrderTotal');
        sessionStorage.removeItem('lastPaymentMethod');
      }
    }
  }
  
  function displayOrderNumber(orderNumber: string, isPaid: boolean) {
    const orderInfo = document.getElementById('order-info');
    const orderNumberEl = document.getElementById('order-number');
    const paymentStatus = document.getElementById('payment-status');
    
    if (orderInfo && orderNumberEl) {
      orderInfo.classList.remove('hidden');
      orderNumberEl.textContent = orderNumber;
    }
    
    if (paymentStatus) {
      if (isPaid) {
        paymentStatus.innerHTML = '<span class="text-green-600 font-medium">✓ Payment Successful</span>';
      } else {
        paymentStatus.innerHTML = '<span class="text-amber-600 font-medium">Pay at pickup</span>';
      }
      paymentStatus.classList.remove('hidden');
    }
  }
  
  handleStripeSuccess();
</script>
